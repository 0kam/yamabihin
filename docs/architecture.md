# 山岳研究班備品管理スイート アーキテクチャ設計書（更新版）

## 1. システム概要

山岳研究班備品管理スイートは、研究用の備品・機材の購入から設置、メンテナンスまでのライフサイクルを統合的に管理するシステムです。主に以下の3つのアプリケーションから構成されます：

1. **備品管理アプリ** - 基幹となるアプリで、全ての備品情報と移動履歴を管理
2. **カメラ管理アプリ** - 定点カメラとその構成部品の管理、メンテナンス予定を管理
3. **レコーダー管理アプリ** - 音声レコーダーの電池・SDカード交換スケジュールを管理

## 2. 全体アーキテクチャ

システム全体は「クリーンアーキテクチャ」の原則に従い、依存関係が内側から外側に向かう多層構造を採用します。これにより、各コンポーネントの独立性を高め、将来的な拡張性を確保します。

### 2.1 アーキテクチャ図

```
+--------------------------------------+
|             クライアント層             |
|  +--------+  +--------+  +--------+  |
|  | 備品管理 |  | カメラ管理 |  |レコーダー管理|  |
|  | フロント |  | フロント |  | フロント |  |
|  +--------+  +--------+  +--------+  |
+--------------------------------------+
               |
+--------------------------------------+
|              API層                   |
|  +--------+  +--------+  +--------+  |
|  | 備品管理 |  | カメラ管理 |  |レコーダー管理|  |
|  |   API   |  |   API   |  |   API   |  |
|  +--------+  +--------+  +--------+  |
+--------------------------------------+
               |
+--------------------------------------+
|           ドメイン層                  |
|  +---------------------------------+ |
|  |           共通サービス           | |
|  | +--------+ +--------+ +--------+ | |
|  | | 認証機能 | | ログ機能 | | CSVエクス| | |
|  | |        | |        | | ポート  | | |
|  | +--------+ +--------+ +--------+ | |
|  +---------------------------------+ |
|                                      |
|  +---------------------------------+ |
|  |         アプリケーションサービス    | |
|  | +--------+ +--------+ +--------+ | |
|  | | 備品管理 | | カメラ管理 | |レコーダー| | |
|  | |サービス | |サービス  | |サービス | | |
|  | +--------+ +--------+ +--------+ | |
|  +---------------------------------+ |
|                                      |
|  +---------------------------------+ |
|  |         ドメインモデル           | |
|  | +--------+ +--------+ +--------+ | |
|  | | 備品    | | カメラ  | |レコーダー| | |
|  | |モデル   | |モデル   | |モデル   | | |
|  | +--------+ +--------+ +--------+ | |
|  +---------------------------------+ |
+--------------------------------------+
               |
+--------------------------------------+
|           データアクセス層            |
|  +--------+  +--------+  +--------+  |
|  | 備品管理 |  | カメラ管理 |  |レコーダー管理|  |
|  |リポジトリ|  |リポジトリ|  |リポジトリ|  |
|  +--------+  +--------+  +--------+  |
+--------------------------------------+
               |
+--------------------------------------+
|            データベース層             |
|  +--------+  +--------+  +--------+  |
|  | 備品DB  |  | カメラDB |  |レコーダーDB|  |
|  +--------+  +--------+  +--------+  |
+--------------------------------------+
```

### 2.2 技術スタック

以下の技術スタックを採用します：

- **フロントエンド**：
  - React（指定あり）
  - React Router（SPA構造のため）
  - Material-UI または Ant Design（スマホ対応UIフレームワーク）
  - Axios（APIリクエスト用）
  - Leaflet（地図表示用）

- **バックエンド**：
  - Node.js + Express（シンプルかつ拡張性に優れたフレームワーク）
  - PostgreSQL（リレーショナルデータベースによるデータ整合性確保）
  - TypeORM（ORM）

- **認証**：
  - JWT（JSON Web Token）による単純な認証
  - 単一のパスワードとユーザー名入力により操作者を特定

- **デプロイ**：
  - Docker（コンテナ化によるポータビリティ確保）
  - Docker Compose（マルチコンテナアプリケーションの管理）

## 3. コンポーネント詳細設計

### 3.1 共通基盤コンポーネント

#### 3.1.1 認証モジュール

全アプリケーション共通の認証モジュールを作成します。

```
+-------------------------------------+
|          認証モジュール               |
+-------------------------------------+
| - 単一パスワード認証（3ga98an）     |
| - ユーザー名入力によるアクション記録 |
| - JWTトークン発行                   |
| - セッション管理                    |
+-------------------------------------+
```

#### 3.1.2 CSVエクスポートモジュール

データベースのバックアップとエクスポート機能を提供します。

```
+-------------------------------------+
|        CSVエクスポートモジュール      |
+-------------------------------------+
| - 週次自動エクスポート               |
| - オンデマンドエクスポート           |
| - 日付ベースのファイル名管理         |
| - 各アプリ固有のデータマッパー       |
+-------------------------------------+
```

#### 3.1.3 ファイルアップロードモジュール

写真などのファイルアップロードを扱います。

```
+-------------------------------------+
|      ファイルアップロードモジュール    |
+-------------------------------------+
| - 画像リサイズ（最大1200px）        |
| - 複数ファイル対応                  |
| - JPEG/PNG/GIF形式対応             |
| - パス管理                         |
+-------------------------------------+
```

### 3.2 備品管理アプリ

備品管理アプリは基幹システムとして、他のアプリケーションからも参照されるマスターデータを管理します。

#### 3.2.1 データモデル

```
+--------------------+       +--------------------+
|       備品          |       |      移動履歴       |
+--------------------+       +--------------------+
| bihin_id (PK)      |<----->| bihin_id (FK)     |
| type               |       | movement_id (PK)   |
| vendor             |       | who_moved          |
| model_name         |       | when_moved         |
| serial_number      |       | where_moved        |
| who_bought         |       | where_moved_detail |
| is_property        |       | why_moved          |
| when_bought        |       | movement_memo      |
| why_bought         |       | who_wrote_this     |
| bought_memo        |       | when_wrote_this    |
| who_wrote_this     |       | movement_photo_paths|
| when_wrote_this    |       +--------------------+
| bihin_photo_paths  |
+--------------------+
```

### 3.3 カメラ管理アプリ

カメラ管理アプリは備品管理アプリとの連携を前提に、カメラ特有の管理機能を提供します。

#### 3.3.1 データモデル

```
+--------------------+       +--------------------+
|     カメラセット     |       |   カメラ構成備品    |
+--------------------+       +--------------------+
| camera_set_id (PK) |<----->| camera_set_id (FK)|
| location           |       | bihin_id (FK)      |
| area_id            |       | component_type     |
| lon                |       | role               |
| lat                |       | status             |
| direction          |       | installation_date  |
| installation_date  |       | who_wrote_this     |
| last_maintenance   |       | when_wrote_this    |
| next_maintenance   |       +--------------------+
| status             |                 ↑
| manager            |                 |
| description        |       +--------------------+
| who_wrote_this     |       |  カメラメンテナンス  |
| when_wrote_this    |<----->+--------------------+
| description_image_paths |   | maintenance_id (PK)|
| sample_image_paths |       | camera_set_id (FK) |
+--------------------+       | maintenance_date   |
                             | maintenance_type   |
                             | description        |
                             | performed_by       |
                             | who_wrote_this     |
                             | when_wrote_this    |
                             | camera_maintenance_image_paths |
                             +--------------------+
```

### 3.4 レコーダー管理アプリ

レコーダー管理アプリは電池・SDカード交換スケジュールの管理を中心に構築します。

#### 3.4.1 データモデル

```
+--------------------+       +--------------------+
|     レコーダー      |       |   交換スケジュール   |
+--------------------+       +--------------------+
| recorder_id (PK)   |<----->| recorder_id (FK)  |
| bihin_id (FK)      |       | schedule_id (PK)   |
| location           |       | battery_type       |
| lon                |       | battery_voltage    |
| lat                |       | battery_capacity   |
| area_id            |       | daily_power_usage  |
| installation_date  |       | last_battery_change|
| recording_schedule |       | next_battery_change|
| status             |       | storage_capacity   |
| manager            |       | daily_storage_usage|
| manager_email      |       | last_storage_change|
| who_wrote_this     |       | next_storage_change|
| when_wrote_this    |       | notification_sent  |
| installation_image_paths |  | who_wrote_this     |
+--------------------+       | when_wrote_this    |
         ↑                   +--------------------+
         |                             ↑
         |                             |
+--------------------+                 |
| 交換・メンテナンス記録|<----------------+
+--------------------+
| record_id (PK)     |
| recorder_id (FK)   |
| record_date        |
| performed_by       |
| battery_changed    |
| battery_type       |
| battery_voltage    |
| battery_capacity   |
| storage_changed    |
| storage_capacity   |
| schedule_changed   |
| new_schedule       |
| power_usage        |
| storage_usage      |
| other_maintenance  |
| maintenance_type   |
| description        |
| who_wrote_this     |
| when_wrote_this    |
+--------------------+
```

## 4. 画面設計

### 4.1 認証画面・ダッシュボード

- **ログイン画面**: ユーザー名とパスワード入力
- **ダッシュボード**: 各アプリへのリンク、近日中のメンテナンス予定一覧

### 4.2 備品管理アプリ画面

- **備品一覧画面**: 検索、フィルタリング、ソート機能付き一覧表示
- **備品登録画面**: 新規備品の情報入力フォーム
- **備品詳細画面**: 備品情報と写真、移動履歴の表示
- **移動履歴登録画面**: 備品の移動情報入力フォーム

### 4.3 カメラ管理アプリ画面

- **カメラセット一覧画面**: エリア・状態でフィルタリングできる一覧
- **カメラセット登録画面**: 設置場所、緯度・経度、説明等の入力
- **カメラセット詳細画面**: カメラの基本情報、構成部品、メンテナンス履歴
- **構成部品管理画面**: カメラを構成する備品の追加・管理
- **メンテナンス記録画面**: メンテナンス履歴の記録・閲覧

### 4.4 レコーダー管理アプリ画面

- **レコーダー一覧画面**: エリア・交換予定日でフィルタリングできる一覧
- **レコーダー登録画面**: 機器情報、位置情報、録音スケジュール設定
- **レコーダー詳細画面**: 基本情報、交換スケジュール、メンテナンス履歴
- **交換・メンテナンス記録画面**: バッテリー交換、SDカード交換、スケジュール変更、その他メンテナンスを統合した記録画面

#### 4.4.1 交換・メンテナンス記録画面の詳細設計

```
+------------------------------------------+
| レコーダー管理 > 交換・メンテナンス記録  |
+------------------------------------------+
|                                          |
| 【レコーダー情報】                       |
| ID: REC00008                            |
| 設置場所: 知床・羅臼                     |
|                                          |
| 実施日*                                  |
| [カレンダーから選択]                     |
|                                          |
| 実施者*                                  |
| [                                ]       |
|                                          |
| 【作業内容】                             |
| バッテリー交換: [✓] はい [ ] いいえ      |
| SDカード交換: [✓] はい [ ] いいえ        |
| 録音スケジュール変更: [ ] はい [✓] いいえ |
| その他のメンテナンス: [✓] はい [ ] いいえ |
|                                          |
| 【バッテリー交換情報】                   |
| 新しいバッテリータイプ                   |
| [単3アルカリ ▼]                         |
|                                          |
| 新しいバッテリー電圧                     |
| [1.5] V                                 |
|                                          |
| 新しいバッテリー容量                     |
| [2500] mAh                              |
|                                          |
| 【SDカード交換情報】                     |
| 新しいストレージ容量                     |
| [32] GB                                 |
|                                          |
| 【録音スケジュール変更情報】             |
| 開始時間: [04 ▼] : [00 ▼]              |
| 終了時間: [20 ▼] : [00 ▼]              |
| 録音間隔: オン[10]分 オフ[20]分          |
| サンプリングレート: [44100] Hz           |
| チャンネル数: [ステレオ ▼]               |
|                                          |
| 1日あたりの電力消費                      |
| [210] mWh                               |
|                                          |
| 1日あたりのストレージ消費                |
| [250] MB                                |
|                                          |
| 【その他のメンテナンス詳細】             |
| メンテナンス種類:                        |
| [ ] 故障修理 [✓] 清掃 [ ] 点検          |
| [ ] ファームウェア更新 [ ] その他        |
|                                          |
| 詳細説明:                                |
| [マイク部分の清掃を実施しました。...]    |
|                                          |
| +----------------------------------+     |
| |          キャンセル              |     |
| +----------------------------------+     |
|                                          |
| +----------------------------------+     |
| |            完了                 |     |
| +----------------------------------+     |
|                                          |
+------------------------------------------+
```

## 5. 画面遷移設計

### 5.1 全体画面遷移図

```
ログイン画面
    │
    ↓
ダッシュボード
    │
    ├───→ 備品管理アプリ
    │         │
    │         ├───→ 備品一覧 ←──→ 備品登録
    │         │         │
    │         │         ↓
    │         │     備品詳細 ←──→ 備品編集
    │         │         │
    │         │         ↓
    │         │     移動履歴登録
    │         │
    ├───→ カメラ管理アプリ
    │         │
    │         ├───→ カメラセット一覧 ←──→ カメラセット登録
    │         │           │
    │         │           ↓
    │         │     カメラセット詳細 ←──→ カメラセット編集
    │         │           │
    │         │           ├───→ 構成部品一覧 ←──→ 部品追加
    │         │           │
    │         │           ├───→ メンテナンス記録
    │         │           │
    │         │           └───→ 写真ギャラリー
    │         │
    └───→ レコーダー管理アプリ
              │
              ├───→ レコーダー一覧 ←──→ レコーダー登録
              │           │
              │           ↓
              │     レコーダー詳細 ←──→ レコーダー編集
              │           │
              │           ├───→ 交換・メンテナンス記録
              │           │
              │           └───→ 写真ギャラリー
```

## 6. データフロー

各アプリケーション間のデータフローを以下に示します：

### 6.1 備品データフロー

```
備品管理アプリ
    ↑ ↓
    │ │ 備品参照
    │ │ 移動履歴追加
    ↑ ↓
+-------------------+
|                   |
| カメラ管理アプリ   | ←→ レコーダー管理アプリ
|                   |
+-------------------+
```

### 6.2 レコーダー交換通知フロー

```
+-------------------+    +-------------------+
| スケジューラ       | → | レコーダー情報     |
| (定期チェック)     |    | (交換期限確認)    |
+-------------------+    +-------------------+
                               │
                               ↓
                         +-------------------+
                         | 通知サービス      |
                         | (メール送信)      |
                         +-------------------+
                               │
                               ↓
                         +-------------------+
                         | 管理者            |
                         +-------------------+
```

## 7. 主要機能の実装方針

### 7.1 位置情報管理

カメラ・レコーダーの位置情報は以下の方法で管理します：

- 緯度・経度情報をデータベースに保存
- 地理院地図APIを利用して、登録・閲覧時に地図上で位置を確認可能
- マーカークリックで詳細情報を表示するポップアップ機能

### 7.2 交換スケジュール計算

レコーダーの交換スケジュールは以下のロジックで計算します：

- バッテリー交換予定日 = 最終交換日 + (バッテリー容量 ÷ 1日あたりの電力消費 × バッテリー電圧)
- ストレージ交換予定日 = 最終交換日 + (ストレージ容量 ÷ 1日あたりのストレージ消費)

### 7.3 写真管理

写真は以下の方針で管理します：

- アップロード時にリサイズ処理（長辺1200px以下）
- カテゴリ別の保存（設置状況、サンプル画像、メンテナンス等）
- サムネイル自動生成
- ギャラリー表示機能

## 8. 将来拡張性

システム設計における拡張性確保のための工夫：

1. **モジュール分割**：機能ごとのマイクロサービス化による独立した開発・拡張
2. **APIゲートウェイ**：共通のAPIゲートウェイを通じた連携
3. **プラグイン構造**：新しい機能をプラグインとして追加できる構造
4. **共通コンポーネント**：認証・ログ・ファイル管理などの共通機能の再利用
5. **関係の明確化**：リレーショナルデータベースによる明示的なデータ関連の定義
6. **マイグレーション管理**：データベーススキーマの変更を管理するマイグレーションツールの活用

## 9. 実装ロードマップ

1. **フェーズ1**：共通基盤（認証・ファイル管理）+ 備品管理アプリの実装
2. **フェーズ2**：カメラ管理アプリの実装
3. **フェーズ3**：レコーダー管理アプリの実装
4. **フェーズ4**：交換・メンテナンス記録機能、CSVエクスポート、通知機能の実装
5. **フェーズ5**：UI/UX改善、パフォーマンス最適化