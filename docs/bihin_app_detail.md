# 備品管理アプリ 詳細設計書

## 1. 概要

備品管理アプリは山岳研究班備品管理スイートの基幹システムとして、研究用備品の登録から移動履歴の管理までを一元的に行うアプリケーションです。他のアプリケーション（カメラ管理、レコーダー管理）からも参照される中心的なデータを提供します。

## 2. データモデル詳細

### 2.1 備品テーブル（bihins）

| フィールド名 | データ型 | 説明 | 制約 |
|------------|---------|------|------|
| bihin_id | String | 備品ID | 主キー、自動生成 |
| type | String | 備品タイプ | 必須、選択式 |
| vendor | String | メーカー | 必須 |
| model_name | String | 製品名 | 必須 |
| serial_number | String | シリアル番号 | 任意 |
| who_bought | String | 購入者 | 必須、選択式 |
| is_property | Boolean | 資産の有無 | 必須 |
| when_bought | Date | 購入時期 | 必須 |
| why_bought | String | 購入目的 | 必須 |
| bought_memo | String | メモ | 任意 |
| bihin_photo_paths | [String] | 写真パスの配列 | 任意 |
| who_wrote_this | String | 登録ユーザー名 | 自動記録 |
| when_wrote_this | Date | 登録日時 | 自動記録 |
| last_updated | Date | 最終更新日時 | 自動記録 |

#### 備品タイプ選択肢
- 一眼レフカメラ本体
- レンズ
- 音声レコーダー
- トラップカメラ
- 電池
- マイコン
- PC周辺機器
- 記録媒体（SDカード等）
- 気象観測装置
- その他

#### 購入者選択肢
- 筑波大学
- 北海道大学
- 東邦大学
- 国環研

### 2.2 移動履歴テーブル（movements）

| フィールド名 | データ型 | 説明 | 制約 |
|------------|---------|------|------|
| movement_id | String | 移動履歴ID | 主キー、自動生成 |
| bihin_id | String | 備品ID | 外部キー(bihins) |
| who_moved | String | 移動者 | 必須 |
| when_moved | Date | 移動日 | 必須 |
| where_moved | String | 移動エリア | 必須、選択式 |
| where_moved_detail | String | 移動場所の詳細 | 任意 |
| why_moved | String | 移動目的 | 任意 |
| movement_memo | String | メモ | 任意 |
| movement_photo_paths | [String] | 写真パスの配列 | 任意 |
| who_wrote_this | String | 登録ユーザー名 | 自動記録 |
| when_wrote_this | Date | 登録日時 | 自動記録 |
| last_updated | Date | 最終更新日時 | 自動記録 |

#### 移動エリア選択肢
- 知床
- 大雪山
- 早池峰
- 飯豊山
- 南三陸
- 白山
- 爺ヶ岳
- 立山
- 蝶ヶ岳・常念岳
- 根子岳
- 北岳
- 南ア(井川)
- 富士山
- 相模川流域
- 筑波大
- 北海道大
- 東邦大
- 国環研
- 岩手県博
- 飯豊を愛する会
- 十山
- その他（この場合、自由入力可能）

### 2.3 エリアマスターテーブル（areas）

| フィールド名 | データ型 | 説明 | 制約 |
|------------|---------|------|------|
| area_id | String | エリアID | 主キー、自動生成 |
| area_name | String | エリア名 | 必須、一意 |
| is_default | Boolean | デフォルトエリアかどうか | 必須 |
| who_wrote_this | String | 登録ユーザー名 | 自動記録 |
| when_wrote_this | Date | 登録日時 | 自動記録 |

## 3. 画面詳細設計

### 3.1 備品一覧画面

**目的**: 登録されている備品の一覧を表示し、検索・ソート機能を提供する画面

**主要コンポーネント**:
- 検索バー: 備品のタイプ、メーカー、製品名などで検索
- フィルターコントロール: タイプ、購入者、購入日で絞り込み
- ソートコントロール: タイプ、購入日などでソート
- 備品リスト: カード形式で表示
- 新規登録ボタン: 備品登録画面へ遷移
- ページネーションコントロール: 複数ページの結果を閲覧

**API連携**:
- `GET /api/bihin?query={検索語}&type={タイプ}&who_bought={購入者}&sort={ソート条件}&page={ページ番号}`

**特記事項**:
- 大量のデータを扱うため、スクロール中のカード遅延読み込み（Lazy Loading）を実装
- 最終更新日時が新しいデータを視覚的に強調（背景色など）

### 3.2 備品登録画面

**目的**: 新規備品を登録するためのフォーム画面

**主要コンポーネント**:
- フォーム入力フィールド（タイプ、メーカー、製品名など）
- 写真アップロードエリア
- 入力検証機能
- 送信/キャンセルボタン

**入力検証ルール**:
- 必須項目（タイプ、メーカー、製品名、購入者、資産の有無、購入時期、購入目的）の入力チェック
- 写真サイズの制限（1枚あたり最大5MB）
- 写真形式の制限（JPEG、PNG、GIF形式のみ）

**API連携**:
- 写真アップロード: `POST /api/upload/bihin`
- 備品登録: `POST /api/bihin`

**特記事項**:
- 入力中のデータを一時保存する機能（ブラウザ再読み込み対策）
- 同じタイプ・メーカーの過去登録データを参照する入力支援機能

### 3.3 備品詳細画面

**目的**: 選択した備品の詳細情報と移動履歴を表示する画面

**主要コンポーネント**:
- 備品基本情報表示エリア
- 写真ギャラリーエリア
- 操作ボタン（編集、削除）
- 移動履歴リスト
- 移動履歴追加ボタン

**API連携**:
- 備品詳細取得: `GET /api/bihin/{bihin_id}`
- 移動履歴取得: `GET /api/bihin/{bihin_id}/movements`
- 備品削除: `DELETE /api/bihin/{bihin_id}`

**特記事項**:
- 写真をタップすると拡大表示するライトボックス機能
- 削除時の確認ダイアログ（移動履歴も全て削除されることを警告）
- この備品を使用しているカメラやレコーダーがある場合、警告表示と削除制限

### 3.4 備品編集画面

**目的**: 既存の備品情報を編集するためのフォーム画面

**主要コンポーネント**:
- 既存データがプリロードされたフォーム入力フィールド
- 写真管理エリア（既存写真の表示、削除、新規追加）
- 送信/キャンセルボタン

**API連携**:
- 備品詳細取得: `GET /api/bihin/{bihin_id}`
- 写真アップロード: `POST /api/upload/bihin`
- 写真削除: `DELETE /api/files/{path}`
- 備品更新: `PUT /api/bihin/{bihin_id}`

**特記事項**:
- 編集履歴を自動的に記録（最終更新日時と更新者）
- 変更前後の差分を視覚的に表示（任意）

### 3.5 移動履歴登録画面

**目的**: 備品の移動履歴を登録するためのフォーム画面

**主要コンポーネント**:
- 備品情報表示エリア（どの備品の移動履歴か明示）
- 移動情報入力フォーム
- 写真アップロードエリア
- 送信/キャンセルボタン

**入力検証ルール**:
- 必須項目（移動者、移動日、移動エリア）の入力チェック
- 移動日は過去または当日の日付のみ許可
- 写真サイズの制限（1枚あたり最大5MB）

**API連携**:
- 写真アップロード: `POST /api/upload/movement`
- 移動履歴登録: `POST /api/bihin/{bihin_id}/movements`

**特記事項**:
- 移動エリアで「その他」を選択した場合、テキスト入力フィールドを表示
- 同じ備品の過去の移動履歴を参照できる機能（任意）

## 4. APIエンドポイント詳細

### 4.1 備品管理API

| エンドポイント | メソッド | 説明 | リクエストパラメータ | レスポンス |
|--------------|---------|------|-------------------|----------|
| `/api/bihin` | GET | 備品一覧取得 | `query`, `type`, `who_bought`, `sort`, `page`, `limit` | 備品リスト、合計件数 |
| `/api/bihin` | POST | 備品登録 | 備品情報 | 登録した備品情報 |
| `/api/bihin/{id}` | GET | 備品詳細取得 | `id` | 備品詳細情報 |
| `/api/bihin/{id}` | PUT | 備品更新 | `id`, 更新情報 | 更新後の備品情報 |
| `/api/bihin/{id}` | DELETE | 備品削除 | `id` | 成功/失敗フラグ |
| `/api/bihin/{id}/movements` | GET | 移動履歴取得 | `id` | 移動履歴リスト |
| `/api/bihin/{id}/movements` | POST | 移動履歴登録 | `id`, 移動情報 | 登録した移動履歴 |
| `/api/movements/{id}` | PUT | 移動履歴更新 | `id`, 更新情報 | 更新後の移動履歴 |
| `/api/movements/{id}` | DELETE | 移動履歴削除 | `id` | 成功/失敗フラグ |
| `/api/areas` | GET | エリア一覧取得 | なし | エリアリスト |
| `/api/areas` | POST | エリア追加 | エリア名 | 追加したエリア情報 |

### 4.2 ファイル管理API

| エンドポイント | メソッド | 説明 | リクエストパラメータ | レスポンス |
|--------------|---------|------|-------------------|----------|
| `/api/upload/bihin` | POST | 備品写真アップロード | `files` (multipart/form-data) | アップロードしたファイルパス |
| `/api/upload/movement` | POST | 移動履歴写真アップロード | `files` (multipart/form-data) | アップロードしたファイルパス |
| `/api/files/{path}` | DELETE | ファイル削除 | `path` | 成功/失敗フラグ |

## 5. コンポーネント構成

### 5.1 フロントエンドコンポーネント

```
src/
├── components/
│   ├── common/           # 共通コンポーネント
│   │   ├── Header.jsx    # ヘッダーコンポーネント
│   │   ├── Footer.jsx    # フッターコンポーネント
│   │   ├── Sidebar.jsx   # サイドメニューコンポーネント
│   │   ├── Loading.jsx   # ローディングインジケーター
│   │   ├── Alert.jsx     # アラートコンポーネント
│   │   ├── PhotoUpload.jsx  # 写真アップロードコンポーネント
│   │   └── PhotoGallery.jsx # 写真ギャラリーコンポーネント
│   │
│   ├── bihin/            # 備品管理関連コンポーネント
│   │   ├── BihinList.jsx     # 備品一覧表示
│   │   ├── BihinCard.jsx     # 備品カード表示
│   │   ├── BihinForm.jsx     # 備品登録/編集フォーム
│   │   ├── BihinDetail.jsx   # 備品詳細表示
│   │   ├── MovementList.jsx  # 移動履歴リスト
│   │   └── MovementForm.jsx  # 移動履歴登録フォーム
│   │
│   └── ui/               # UIコンポーネント
│       ├── Button.jsx    # ボタンコンポーネント
│       ├── Input.jsx     # 入力フィールドコンポーネント
│       ├── Select.jsx    # 選択フィールドコンポーネント
│       └── Modal.jsx     # モーダルコンポーネント
│
├── pages/                 # ページコンポーネント
│   ├── LoginPage.jsx     # ログインページ
│   ├── DashboardPage.jsx # ダッシュボードページ
│   ├── bihin/            # 備品管理ページ
│   │   ├── BihinListPage.jsx    # 備品一覧ページ
│   │   ├── BihinRegisterPage.jsx # 備品登録ページ
│   │   ├── BihinDetailPage.jsx  # 備品詳細ページ
│   │   ├── BihinEditPage.jsx    # 備品編集ページ
│   │   └── MovementRegisterPage.jsx # 移動履歴登録ページ
│   │
│   └── [other app pages]  # 他アプリページ
│
├── services/              # APIサービス
│   ├── authService.js    # 認証サービス
│   ├── bihinService.js   # 備品サービス
│   ├── movementService.js # 移動履歴サービス
│   └── fileService.js    # ファイル管理サービス
│
└── utils/                 # ユーティリティ
    ├── validation.js     # バリデーション
    ├── formatters.js     # データフォーマッター
    └── constants.js      # 定数定義
```

### 5.2 バックエンドコンポーネント

```
src/
├── controllers/           # コントローラー
│   ├── authController.js  # 認証コントローラー
│   ├── bihinController.js # 備品コントローラー
│   ├── movementController.js # 移動履歴コントローラー
│   └── fileController.js  # ファイル管理コントローラー
│
├── models/                # データモデル
│   ├── bihinModel.js     # 備品モデル
│   ├── movementModel.js  # 移動履歴モデル
│   └── areaModel.js      # エリアモデル
│
├── services/              # ビジネスロジック
│   ├── bihinService.js   # 備品サービス
│   ├── movementService.js # 移動履歴サービス
│   └── exportService.js  # エクスポートサービス
│
├── repositories/          # データアクセス
│   ├── bihinRepository.js # 備品リポジトリ
│   ├── movementRepository.js # 移動履歴リポジトリ
│   └── areaRepository.js  # エリアリポジトリ
│
├── middlewares/           # ミドルウェア
│   ├── authMiddleware.js # 認証ミドルウェア
│   ├── validationMiddleware.js # バリデーションミドルウェア
│   └── logMiddleware.js  # ログミドルウェア
│
├── utils/                 # ユーティリティ
│   ├── logger.js         # ロガー
│   ├── fileUpload.js     # ファイルアップロード処理
│   └── csvExport.js      # CSVエクスポート処理
│
└── routes/                # ルーティング
    ├── authRoutes.js     # 認証ルート
    ├── bihinRoutes.js    # 備品ルート
    ├── movementRoutes.js # 移動履歴ルート
    └── fileRoutes.js     # ファイル管理ルート
```

## 6. 実装上の注意点

### 6.1 写真管理

- 写真ファイルはサーバーの`/uploads/bihin/`および`/uploads/movement/`ディレクトリに保存
- ファイル名は`{タイムスタンプ}_{ランダム文字列}.{拡張子}`の形式で生成
- アップロード時に長辺1200px以下にリサイズ処理
- サムネイル（長辺200px）も自動生成し、`/uploads/thumbnails/`に保存

### 6.2 エリア管理

- 初期状態で定義されたエリアをデータベースに登録（`is_default=true`）
- ユーザーが「その他」を選択し、新しいエリアを追加した場合は`is_default=false`で登録
- エリア名の重複チェックを行い、既存のエリアがある場合は新規登録せずに既存のものを使用

### 6.3 パフォーマンス対策

- 備品一覧はページネーションを実装（デフォルト15件/ページ）
- 一覧画面では必要最小限のデータのみ取得し、詳細画面で全データを取得
- 写真はサムネイルのみ先に読み込み、大きい画像は必要時に遅延読み込み
- 移動履歴は備品詳細画面初期表示時には最新5件のみ表示し、「すべて表示」ボタンで全件表示

### 6.4 移動履歴の自動生成

- カメラ管理アプリでカメラに備品を追加した場合、自動的に移動履歴を生成
- レコーダー管理アプリでレコーダーを登録した場合、自動的に移動履歴を生成
- 自動生成された移動履歴の`who_wrote_this`には操作したユーザー名を記録
- 自動生成された移動履歴の`who_moved`や`why_moved`には適切なデフォルト値を設定

## 7. テスト計画

### 7.1 単体テスト

- 各コントローラーのメソッドに対するテスト
- バリデーションロジックのテスト
- ファイルアップロード処理のテスト

### 7.2 統合テスト

- API エンドポイントのテスト
- データベース操作の整合性テスト
- アプリケーション間の連携テスト

### 7.3 UIテスト

- 各画面の表示テスト
- ユーザー操作フローのテスト
- レスポンシブデザインのテスト（スマートフォン/タブレット/デスクトップ）